<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.presto.api.order.entity.Order">

    <resultMap id="orderResult" type="com.presto.api.order.ro.OrderRO">
        <id column="id" property="id"/>
        <id column="user_id" property="userId"/>
        <id column="status" property="status"/>
        <id column="amount" property="amount"/>
        <id column="date_from" property="dateFrom"/>
        <id column="date_end" property="dateEnd"/>
        <id column="order_date" property="orderDate"/>
        <id column="order_date" property="orderDate"/>
        <id column="mobile" property="mobile"/>
        <collection property="orderDetails" ofType="com.presto.api.order.ro.OrderDetailRO">
            <result column="d_id" property="id"/>
            <result column="user_book_id" property="userBookId"/>
            <result column="book_id" property="bookId"/>
            <result column="book_name" property="bookName"/>
            <result column="book_author" property="bookAuthor"/>
            <result column="price" property="price"/>
            <result column="book_press" property="bookPress"/>
            <result column="book_isbn" property="bookIsbn"/>
        </collection>
    </resultMap>

    <select id="queryOrderByUser" resultMap="orderResult">
        select bo.id,
               bo.user_id,
               bo.status,
               bo.amount,
               bo.date_from,
               bo.date_end,
               bo.order_date,
               uu.mobile,
               bod.id as d_id,
               bub.id as user_book_id,
               bb.id as book_id,
               bb.book_name,
               bb.price,
               bb.book_author,
               bb.book_press,
               bb.book_isbn
        from b_order bo,u_user uu,b_order_detail bod,b_user_book bub,b_books bb
        where bo.user_id = uu.id
          and bo.deleted_flag = 0
          and bod.order_id = bo.id
          and bub.id = bod.user_book_id
          and bb.id = bub.book_id
          and bo.user_id = #{userId}
          <if test="status != null">
              bo.status = #{status}
          </if>
    </select>
</mapper>
